---
title: "Yield_analysis"
output: html_document
---
```
####David Makowski INRAE###
####18/02/2021####
#Edited by Rose Abramoff - starting 22/02/2021
```
#Load libraries
```{r load-libraries}
library(openxlsx)
library(raster)
library(rgdal)
library(rgeos)
library(maps)
library(mapdata)
library(dplyr)
library(lme4)
library(lmerTest)
library(spaMM)
library(ranger)
library(ggplot2)
library(pdp)
library(caret)
library(iml)
library(randomForest)
library(gbm)
library(DALEX)
require(MuMIn)
```

#Switches
```{r switches}
same_locations = F
crop_species = c("Maize","Rice","Wheat","Soybean")
do_iml = F
adaptation_types = F
do_maps = T
source('multiplot.R')
```

#Data import
```{r data-import}
datadir <- "/Users/rzabramoff/ownCloud/Collaborations/Makowski_yield/14691579/"
mdatadir <- "/Users/rzabramoff/ownCloud/Collaborations/Makowski_yield/Data/"
TAB<-read.xlsx(paste0(datadir,"Projected_Impacts_datasheet.xlsx"), sheet=1)
head(TAB)

#Extraction of columns
Species<-as.factor(TAB$Crop)
Ref<-TAB$Ref.No
Delta_temp<-as.numeric(TAB$Global.delta.T.from.2005)
Effect<-as.numeric(TAB$"Climate.impacts.relative.to.2005")
CO2<-TAB$CO2
CO2[CO2=="Yes" | CO2=="yes"]<-"Yes"
CO2[CO2=="No"]<-"No"
CO2<-as.factor(CO2)
CO2.ppm<-TAB$CO2.ppm-390
CO2.ppm[CO2=="No"]<-0
Adaptation<-as.factor(TAB$Adaptation)
RCP<-as.factor(TAB$Climate.scenario)
TempAvg<-as.numeric(TAB$Current.Average.Temperature)
Latitude<-TAB$latitude
Longitude<-TAB$longitude
Baseline<-TAB$"Baseline_Mid-point"
Future<-TAB$"Future_Mid-point"
Future_s<-scale(Future)

if(adaptation_types){
#Adaptation <- as.factor(TAB$Adaptation.type)
Fertiliser <- as.factor(TAB$Fertiliser)
Irrigation <- as.factor(TAB$Irrigation)
TAB$Cultivar[TAB$Cultivar=="Yes "] <- "Yes"
Cultivar<-as.factor(TAB$Cultivar)
Soil_organic_matter_management <- as.factor(TAB$Soil.organic.matter.management)
Planting_time <- as.factor(TAB$Planting.time)
Tillage <- as.factor(TAB$Tillage)
Others <- as.factor(TAB$Others)
}
```
#Maps prep
```{r}
makelabelsEW <- function(x) {ifelse(x < 0, parse(text=paste0(x,"^o", "*W")), ifelse(x > 0, parse(text=paste0(x,"^o", "*E")),x))}
makelabelsNS <- function(x) {ifelse(x < 0, parse(text=paste0(x,"^o", "*S")), ifelse(x > 0, parse(text=paste0(x,"^o", "*N")),x))}
wrld <- map_data("world")
xbreaks <- seq(-180,180,60)
xlabels <- makelabelsEW(xbreaks)
ybreaks <- seq(-90,90,30)
ylabels <- makelabelsNS(ybreaks)
gg1 <- ggplot() + 
  geom_polygon(data = wrld, aes(x=long, y = lat, group = group), fill = "lightgray", color = "lightgray") + 
  coord_fixed(1.3) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.ticks = element_blank(), legend.position="bottom",legend.title=element_text(size=15), 
    legend.text=element_text(size=12), axis.text = element_text(size=12))+
 scale_x_continuous("", breaks = xbreaks, labels = xlabels) +
 scale_y_continuous("", breaks = ybreaks, labels = ylabels, limits=c(-60,90))

map_of_df <- function(DATA,crop_species){
gg1 + geom_point(data=DATA, aes(x=Longitude, y=Latitude, color=Effect), pch=16, size=1) + scale_color_gradient2(midpoint=0, low="brown", mid="white", high="darkgreen", limits=c(-100,100)) + ggtitle(crop_species) +
labs(color="Yield Change (%)")
}

hist_of_df <- function(DATA,crop_species){
ggplot(data=DATA, aes(x=Effect)) + 
 geom_histogram() + theme_classic() + ggtitle(crop_species) + scale_fill_continuous() + xlim(-100,150) +
geom_vline(aes(xintercept = mean(Effect)),col='red', lty=2) + geom_vline(aes(xintercept = median(Effect)),col='blue', lty=2) + xlab("Yield Change (%)")
}

map_testing_training <- function(DATA,crop_species){
gg1 + geom_point(data=Training_1[[i]], aes(x=Longitude, y=Latitude), color="darkblue", pch=16, size=1) + geom_point(data=Testing_1[[i]], aes(x=Longitude, y=Latitude), color="darkred", pch=16, size=1) + ggtitle(crop_species)
}
```

#Prep and split data
```{r, prep-data}
if(adaptation_types){
    if(same_locations){
      Loca<-paste(Longitude,Latitude, sep="_") 
        DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,TempAvg, y=Latitude, x=Longitude, Fertiliser,Irrigation,Cultivar,Soil_organic_matter_management,Planting_time,Tillage,Others,Loca)
    } else {
        DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,TempAvg, y=Latitude, x=Longitude, Fertiliser,Irrigation,Cultivar,Soil_organic_matter_management,Planting_time,Tillage,Others)
    }
      DATA<-data.frame(Effect,Species,Delta_temp,CO2.ppm,TempAvg, Future, Latitude, Longitude,Fertiliser,Irrigation,Cultivar,Soil_organic_matter_management,Planting_time,Tillage,Others)
}else{
    if(same_locations){
      Loca<-paste(Longitude,Latitude, sep="_") 
        DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, y=Latitude, x=Longitude, Loca)
    } else {
        DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, y=Latitude, x=Longitude)
    }
      DATA<-data.frame(Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Latitude, Longitude)
}

df <- NULL
df_lm <- NULL
df_xy <- NULL

for (i in 1:length(crop_species)){
df[[i]]<-DATA[DATA$Species==crop_species[i],]
df[[i]]<-na.omit(df[[i]])
df_lm[[i]]<-DATA_lm[DATA_lm$Species==crop_species[i],]
df_lm[[i]]<-na.omit(df_lm[[i]])
#Remove Species
df[[i]]<-df[[i]][ , -which(names(df[[i]]) %in% c("Species"))]
df_lm[[i]]<-df_lm[[i]][ , -which(names(df_lm[[i]]) %in% c("Species"))]

#Remove where N<20
if(adaptation_types){
  df[[i]]<-df[[i]][ , -which(names(df[[i]]) %in% c("Tillage","Soil_organic_matter_management"))]
  df_lm[[i]]<-df_lm[[i]][ , -which(names(df_lm[[i]]) %in% c("Tillage","Soil_organic_matter_management"))]
  
  if(i==1|i==4){
  #Remove SOM management and Tillage and Others
  df[[i]]<-df[[i]][ , -which(names(df[[i]]) %in% c("Others"))]
  df_lm[[i]]<-df_lm[[i]][ , -which(names(df_lm[[i]]) %in% c("Others"))]
  }
  
  if(i==4){
  df[[i]]<-df[[i]][ , -which(names(df[[i]]) %in% c("Irrigation"))]
  df_lm[[i]]<-df_lm[[i]][ , -which(names(df_lm[[i]]) %in% c("Irrigation"))]
  }
}

#Only x and y
df_xy[[i]]<-df[[i]][ , which(names(df[[i]]) %in% c("Effect","Latitude","Longitude"))]

if(do_maps){
pdf(file=paste0(crop_species[[i]],"_effects_meta.pdf"), height=4, width=5)
print(map_of_df(df[[i]],crop_species[i]))
dev.off()
print(map_of_df(df[[i]],crop_species[i]))

pdf(file=paste0(crop_species[[i]],"_effects_hist.pdf"), height=3, width=3)
print(hist_of_df(df[[i]],crop_species[i]))
dev.off()
print(hist_of_df(df[[i]],crop_species[i]))
}
}
```

#Describe data
```{r}
#samples
for(i in 1:length(crop_species)){
print(c(dim(df[[i]])[1], crop_species[i], "samples"))
print(c(length(unique(Locs[[i]])), crop_species[i], "locations"))
print(summary(df[[i]]$Effect))
print(sd(df[[i]]$Effect))
print(sd(df[[i]]$Effect)/sqrt(length(df[[i]]$Effect)))
}
```

#Make Plots
##Make obs v pred pred plots
```{r}
load("saved_MLs_samelocsFALSE_adaptationtypesFALSE_store_predictions_allFALSE.Rdata")
AllOP <- bind_rows(ObsPred, .id = "column_label")
FormOP <- AllOP %>%
  tidyr::pivot_longer(cols=c(Predicted, Observed), names_to="Type") %>%
  group_by(Crop, Site, Type) %>%
  dplyr::summarise(mean = mean(value),
            se = sd(value)/sqrt(n()),
            n = n()) %>%
  tidyr::pivot_wider(names_from = Type, names_sep = ".", values_from = c(mean, se, n))

#mean and se of Observed is redundant, since those don't change over iterations
pdf(file=paste0("FigureS3_samelocs",same_locations,"_adaptypes",adaptation_types,".pdf"), height=4, width=6)
  ggplot(FormOP, aes(x=mean.Observed, y=mean.Predicted)) +
    geom_point() +
    geom_errorbar(aes(ymin=mean.Predicted-se.Predicted, ymax=mean.Predicted+se.Predicted), width=.2,
                 position=position_dodge(0.05)) +
    ylab("Predicted Yield Change (%)") +
    xlab("Observed Yield Change (%)") +
    facet_wrap(~Crop) + theme_bw()
dev.off()
```

##Make PDP plots
###Load the data
```{r}
adaptation_types = TRUE
#PDPeffs[[Nb 1-10]][[Crop 1-4]]
load(paste0("saved_MLs_samelocsFALSE_adaptationtypes",adaptation_types,"_store_PDPs_allTRUE.Rdata"))
```

###Make the plots
```{r}
cbPalette <- c("#000000","#E69F00", "#009E73", "#0072B2", "#CC79A7", "#D55E00", "#56B4E9", "#F0E442")

bindeffs <- function(PDPeffs, Crop.Num) {
  effs <- NULL
for(i in 1:1){
effs[[i]] <- do.call("rbind", PDPeffs[[i]][[Crop.Num]]$results)
effs[[i]]$.crop <- rep(crop_species[Crop.Num], dim(effs[[i]])[1])
}
neweffs <- do.call("rbind", effs)
return(neweffs)
}

maize.effs <- bindeffs(PDPeffs, 1)
rice.effs <- bindeffs(PDPeffs, 2)
wheat.effs <- bindeffs(PDPeffs, 3)
soybean.effs <- bindeffs(PDPeffs, 4)

     efdf <- maize.effs %>% 
       dplyr::full_join(rice.effs) %>%
       dplyr::full_join(wheat.effs) %>%
       dplyr::full_join(soybean.effs) %>%
        group_by(.borders, .feature, .crop) 
     efdf$.crop <- as.factor(efdf$.crop)
     
     #levels(efdf$.crop) <- c("Maize","Rice","Wheat","Soybean")
     
if(adaptation_types){
    efdf.adaptation <- filter(efdf, .feature != "TempAvg" && .feature != "CO2.ppm" && .feature != "Delta_temp" && .feature != "Latitude" && .feature != "Longitude")
    efdf.others <- filter(efdf, .feature == "TempAvg" | .feature == "CO2.ppm" | .feature == "Delta_temp" | .feature == "Latitude" | .feature == "Longitude")
    efdf.adaptation$.feature <- as.factor(efdf.adaptation$.feature)
    levels(efdf.adaptation$.feature) <- c("Cultivar", "Fertilizer", "Irrigation", "Others", "Planting Time")
    efdf.adaptation <- efdf.adaptation %>%
      tidyr::pivot_wider(names_from=.borders, values_from=.value) %>%
      mutate(.value = Yes-No)
}else{
    efdf.adaptation <- efdf[efdf$.feature=="Adaptation",]
    efdf.others <- efdf[efdf$.feature!="Adaptation",]
}
     
     efdf.others$.borders <- as.numeric(efdf.others$.borders)
     efdf.TempAvg <- efdf.others[efdf.others$.feature=="TempAvg",]
     efdf.Delta_temp <- efdf.others[efdf.others$.feature=="Delta_temp",]
     efdf.CO2.ppm <- efdf.others[efdf.others$.feature=="CO2.ppm",]
     efdf.Latitude <- efdf.others[efdf.others$.feature=="Latitude",]
     efdf.Longitude <- efdf.others[efdf.others$.feature=="Longitude",]
    
      ylabs = "Yield Change (%)"
      ylims = range(efdf$.value)+range(efdf$.value)*0.1
      
      ggplot_pdps <- function(efdf, xlabels) {
      ggplot(efdf, aes(.borders, .value, color= .crop)) +
        geom_point(alpha=0.3) + geom_line() +
        ylim(ylims) +
        ylab(ylabs) +
        xlab(xlabels) + 
        theme_bw() + theme(legend.position = "none") +
        scale_color_manual(values = c(cbPalette[1], cbPalette[2], cbPalette[3], cbPalette[4]), labels = c("Maize", "Rice",  "Wheat", "Soybean")) + 
        guides(colour = guide_legend(override.aes = list(size=5)))
      }
      
      ggplot_pdps_latlong <- function(efdf, xlabels) {
      ggplot(efdf, aes(.borders, .value, color= .crop)) +
        geom_point(alpha=0.3) + geom_line() +
        ylim(ylims) +
        ylab(ylabs) +
        xlab(xlabels) + 
        theme_bw() + theme(legend.position = "none") +
        scale_color_manual(values = c(cbPalette[2], cbPalette[4])) + 
        guides(colour = guide_legend(override.aes = list(size=5)))
      }
      
p1 <- ggplot_pdps(efdf.TempAvg, expression("Average Temperature"~degree~"C"))
p2 <- ggplot_pdps(efdf.Delta_temp, expression(Delta~" Temperature"~degree~"C"))
p3 <- ggplot_pdps(efdf.CO2.ppm, expression(Delta~"CO"[2]~"ppm above 390 ppm"))
p4 <- ggplot_pdps_latlong(efdf.Latitude, "Latitude")
p5 <- ggplot_pdps_latlong(efdf.Longitude, "Longitude")

if(adaptation_types){
  p6 <- ggplot(efdf.adaptation, aes(x = .feature, y = .value, fill=.crop)) +
          geom_bar(stat = "identity", position="dodge") + 
          facet_grid(.crop~.) +
          ylim(-16,11) +
          ylab("Yield Improvement with Adaptation (%)") +
          xlab("") + 
          theme_bw() + theme(legend.position = "none", strip.text.x = element_text(size = 5), axis.text.x=element_text(angle = 45, hjust= 1)) +
          scale_fill_manual(values = c(cbPalette[1], cbPalette[2], cbPalette[3], cbPalette[4])) + 
          guides(colour = guide_legend(override.aes = list(size=5)))
}else{
  p6 <- ggplot(efdf.adaptation, aes(x = .borders, y = .value, fill=.crop)) +
          geom_bar(stat = "identity") + 
          ylim(ylims) +
          ylab(ylabs) +
          xlab("") + 
          theme_bw() + theme(legend.position = "none") +
          scale_fill_manual(values = c(cbPalette[1], cbPalette[2], cbPalette[3], cbPalette[4])) + 
          guides(colour = guide_legend(override.aes = list(size=5)))
}
  p7 <- ggplot(efdf.adaptation, aes(x = .feature, y = .value, fill=.crop)) +
          geom_bar(stat = "identity") + 
          ylim(ylims) +
          ylab(ylabs) +
          xlab("") + 
          theme_bw() +
          labs(fill="Crop") +
          scale_fill_manual(values = c(cbPalette[1], cbPalette[2], cbPalette[3], cbPalette[4]), name="Crop") +
          guides(colour = guide_legend(override.aes = list(size=5)))

pdf(file=paste0("adaptation",adaptation_types,"_PDPs.pdf"), height=6, width=6.5)
    multiplot(p1,p2,p3,p4,p5, cols=2)
dev.off()

pdf(file=paste0("adaptation",adaptation_types,"_PDPs_adapt.pdf"), height=6, width=3.25)
    p6
dev.off()

pdf(file=paste0("adaptation",adaptation_types,"_PDPs_legend.pdf"), height=5, width=5)
    p7
dev.off()
```

