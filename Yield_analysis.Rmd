---
title: "Yield_analysis"
output: html_document
---
```
####David Makowski INRAE###
####18/02/2021####
#Edited by Rose Abramoff - starting 22/02/2021
```
```{r global-options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res)
    }
  }
}))
knitr::opts_chunk$set(time_it = TRUE)
```

#Load libraries
```{r load-libraries}
library(openxlsx)
library(raster)
library(rgdal)
library(rgeos)
library(maps)
library(mapdata)
library(dplyr)
library(lme4)
library(lmerTest)
library(spaMM)
library(ranger)
library(ggplot2)
library(pdp)
library(caret)
library(iml)
library(randomForest)
library(gbm)
library(DALEX)
require(MuMIn)
```

#Switches
```{r switches}
same_locations = F #default is same locations
drop_future = T
crop_species = c("Maize","Rice","Wheat","Soybean")
do_iml = T
```

#Data import
```{r data-import}
datadir <- "/Users/rzabramoff/ownCloud/Collaborations/Makowski_yield/Data/"
TAB<-read.xlsx(paste0(datadir,"Projected_Impacts_datasheet_1.3.xlsx"), sheet=1)
head(TAB)

#Extraction of columns
Species<-as.factor(TAB$Crop)
Ref<-TAB$Ref.No.
Sample<-TAB$Sample.No.
Delta_temp<-as.numeric(TAB$Global.delta.T.from.2005)
Effect<-as.numeric(TAB$"Climate.impacts.relative.to.2005.(%)")
CO2<-TAB$CO2
CO2[CO2=="Yes" | CO2=="yes"]<-"Yes"
CO2[CO2=="No"]<-"No"
CO2<-as.factor(CO2)
CO2.ppm<-TAB$CO2.ppm-390
CO2.ppm[CO2=="No"]<-0
Adaptation<-as.factor(TAB$Adaptation)
RCP<-as.factor(TAB$RCP.Scenarios)
TempAvg<-as.numeric(TAB$Current.Average.Temperature)
Latitude<-TAB$latitude
Longitude<-TAB$longitude
Baseline<-TAB$"Baseline_Mid-point"
Future<-TAB$"Future_Mid-point"
Future_s<-scale(Future)
```
#Maps prep
```{r}
makelabelsEW <- function(x) {ifelse(x < 0, parse(text=paste0(x,"^o", "*W")), ifelse(x > 0, parse(text=paste0(x,"^o", "*E")),x))}
makelabelsNS <- function(x) {ifelse(x < 0, parse(text=paste0(x,"^o", "*S")), ifelse(x > 0, parse(text=paste0(x,"^o", "*N")),x))}
wrld <- map_data("world")
xbreaks <- seq(-180,180,60)
xlabels <- makelabelsEW(xbreaks)
ybreaks <- seq(-90,90,30)
ylabels <- makelabelsNS(ybreaks)
gg1 <- ggplot() + 
  geom_polygon(data = wrld, aes(x=long, y = lat, group = group), fill = NA, color = "black") + 
  coord_fixed(1.3) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.ticks = element_blank(), legend.position="bottom",legend.title=element_text(size=15), 
    legend.text=element_text(size=12), axis.text = element_text(size=12))+
 scale_x_continuous("", breaks = xbreaks, labels = xlabels) +
 scale_y_continuous("", breaks = ybreaks, labels = ylabels)

map_of_df <- function(DATA,crop_species){
gg1 + geom_point(data=DATA, aes(x=Longitude, y=Latitude, color=Effect), pch=16, size=1) + scale_color_gradient2(midpoint=0, low="brown", mid="white", high="darkgreen", limits=c(-100,100)) + ggtitle(crop_species)
}

hist_of_df <- function(DATA,crop_species){
ggplot(data=DATA, aes(x=Effect)) + 
 geom_histogram() + theme_classic() + ggtitle(crop_species) + scale_fill_continuous() + xlim(-100,100) + geom_vline(aes(xintercept = mean(Effect)),col='red', lty=2) + geom_vline(aes(xintercept = median(Effect)),col='blue', lty=2)
}

map_testing_training <- function(DATA,crop_species){
gg1 + geom_point(data=Training_1[[i]], aes(x=Longitude, y=Latitude), color="darkblue", pch=16, size=1) + geom_point(data=Testing_1[[i]], aes(x=Longitude, y=Latitude), color="darkred", pch=16, size=1) + ggtitle(crop_species)
}
```

#Prep and split data
```{r, prep-data}
if(same_locations){
  Loca<-paste(Longitude,Latitude, sep="_") 
  if(drop_future){
    DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, y=Latitude, x=Longitude, Loca)
  }else{
    DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Future, y=Latitude, x=Longitude, Loca)
    }
} else {
    if(drop_future){
      DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, y=Latitude, x=Longitude)
    }else{
      DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Future, y=Latitude, x=Longitude)
    }
}

if(drop_future){
  DATA<-data.frame(Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Latitude, Longitude)
} else {
  DATA<-data.frame(Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Future, Latitude, Longitude)
}

df <- NULL
df_lm <- NULL
df_xy <- NULL
Training_xy <- NULL
Testing_xy <- NULL
Training_1 <- NULL
Testing_1 <- NULL
Training_2 <- NULL
Testing_2 <- NULL
Locs <- NULL

for (i in 1:length(crop_species)){
df[[i]]<-DATA[DATA$Species==crop_species[i],]
df[[i]]<-na.omit(df[[i]])
df_lm[[i]]<-DATA_lm[DATA_lm$Species==crop_species[i],]
df_lm[[i]]<-na.omit(df_lm[[i]])
#Remove Species
df[[i]]<-df[[i]][ , -which(names(df[[i]]) %in% c("Species"))]
#print(summary(df[[i]]))
df_lm[[i]]<-df_lm[[i]][ , -which(names(df_lm[[i]]) %in% c("Species"))]
#print(summary(df_lm[[i]]))

#Only x and y
df_xy[[i]]<-df[[i]][ , which(names(df[[i]]) %in% c("Effect","Latitude","Longitude"))]

pdf(file=paste0(crop_species[[i]],"_effects_meta.pdf"), height=4, width=5)
print(map_of_df(df[[i]],crop_species[i]))
dev.off()
print(map_of_df(df[[i]],crop_species[i]))

pdf(file=paste0(crop_species[[i]],"_effects_hist.pdf"), height=3, width=3)
print(hist_of_df(df[[i]],crop_species[i]))
dev.off()
print(hist_of_df(df[[i]],crop_species[i]))

set.seed(1234)
Loc<-paste(df[[i]]$Longitude,df[[i]]$Latitude, sep="_")
Locs[[i]] <- Loc

  #Split at the same locations
if(same_locations){
  ID<-1:length(Loc)
  DATA_sample<-cbind(ID,Loc,df[[i]])
  #Remove locations including one data only
  Loc_1<-names(table(DATA_sample$Loc))[as.numeric(table(DATA_sample$Loc))<2]
  DATA_sample2<-DATA_sample
  if (length(Loc_1)>1) {
    ID_1<-ID[DATA_sample$Loc%in%Loc_1==TRUE]
    DATA_sample2<-DATA_sample[-ID_1,]}
    #Sample one data per location
    new_data <- DATA_sample2 %>% group_by(Loc) %>% sample_n(1)
    ID<-new_data$ID
} else {
  #Split using different locations
  Loc<-paste(df[[i]]$Longitude,df[[i]]$Latitude, sep="_")
  UnLoc<-unique(Loc)
  ID_loc<-sample(x=UnLoc, size=round(0.25*length(UnLoc)))
  ID<-(1:nrow(df[[i]]))[Loc%in%ID_loc==TRUE]
}

Training_xy[[i]]<-df_xy[[i]][-ID,]
Testing_xy[[i]]<-df[[i]][ID,]
Training_1[[i]]<-df[[i]][-ID,]
Testing_1[[i]]<-df[[i]][ID,]
Training_2[[i]]<-df_lm[[i]][-ID,]
Testing_2[[i]]<-df_lm[[i]][ID,]

#Map of data
pdf(file=paste0(crop_species[[i]],"_testing_training.pdf"), height=4, width=5)
print(map_testing_training(df[[i]],crop_species[i]))
dev.off()
print(map_testing_training(df[[i]],crop_species[i]))
}
```

#Describe data
```{r}
#samples
for(i in 1:length(crop_species)){
print(c(dim(df[[i]])[1], crop_species[i], "samples"))
print(c(length(unique(Locs[[i]])), crop_species[i], "locations"))
print(summary(df[[i]]$Effect))
}
```

#Analysis
##ML functions
```{r, ml-functions}
do_GBM <- function(mldfTrain){
fitControl <- caret::trainControl( #10 fold CV
  method = "repeatedcv",
  number = 10,
  repeats = 10 )
set.seed(1234)
gbmFit1 <- caret::train( Effect ~ ., data = mldfTrain,
                    method = "gbm",
                    trControl = fitControl,
                    verbose = FALSE )
return(gbmFit1)
}

pfun <- function(object, newdata) predict(object, data = newdata)$predictions

do_iml_rf <- function(predictor, mod_ml, Training, Testing, PlotTitle){
  
if(do_iml){
imp <- FeatureImp$new(predictor, loss = "mae")

#strength of interactions
interact <- Interaction$new(predictor)

#feature effects
effs <- FeatureEffects$new(predictor, method="pdp")
#plot(effs$results$Latitude$.borders, effs$results$Latitude$.value, type="l") #can recreate to rename y ax but not sure how to recreate rug

#shapley
shapley <- Shapley$new(predictor, x.interest = Training[1,-1])

#plots
print(plot(imp) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(interact) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(effs) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(shapley$plot() + ggtitle(paste0(PlotTitle," ",crop_species)))
}

Pred_ml<-predict(mod_ml, data=Testing)$predictions
RMSEP_ml=sqrt(mean((Testing$Effect-Pred_ml)^2))
print(plot(Testing$Effect,Pred_ml))
return(RMSEP_ml)
}

do_iml_gbm <- function(predictor, mod_ml, Training, Testing, PlotTitle){
imp <- FeatureImp$new(predictor, loss = "mae")

#strength of interactions
interact <- Interaction$new(predictor)

#specify two-way interactions
# interact <- Interaction$new(predictor, feature = "Longitude")
# plot(interact)

#feature effects
effs <- FeatureEffects$new(predictor, method="pdp")
#plot(effs$results$Latitude$.borders, effs$results$Latitude$.value, type="l") #can recreate to rename y ax but not sure how to recreate rug

#shapley
shapley <- Shapley$new(predictor, x.interest = Training[1,-1])

#plots
print(plot(imp) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(interact) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(effs) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(shapley$plot() + ggtitle(paste0(PlotTitle," ",crop_species)))

Pred_ml<-predict(mod_ml, newdata=Testing)
RMSEP_ml=sqrt(mean((Testing$Effect-Pred_ml)^2))
print(plot(Testing$Effect,Pred_ml))
return(RMSEP_ml)
}
```

##Random Forests and GBM
###Spatial RF
```{r spatial-rf}
mod.rf.xy <- NULL
RMSEP_rf_xy <- NULL
R2_rf_xy <- NULL
for(i in 1:length(crop_species)){
set.seed(1234)
mod.rf.xy[[i]] <- ranger(Effect~., data=Training_xy[[i]], num.trees=1000)
print(crop_species[[i]])
print(mod.rf.xy[[i]])

predictor.rf.xy <- Predictor$new(model = mod.rf.xy[[i]], data = Training_xy[[i]][-1], y = Training_xy[[i]]$Effect, predict.fun = pfun)

RMSEP_rf_xy[[i]] <- do_iml_rf(predictor.rf.xy, mod.rf.xy[[i]], Training_xy[[i]], Testing_xy[[i]], PlotTitle="Spatial RF")
R2_rf_xy[[i]] <- mod.rf.xy[[i]]$r.squared
}
```

###Spatial GBM
```{r, spatial-gbm}
mod.gbm.xy <- NULL
RMSEP_gbm_xy <- NULL
R2_gbm_xy <- NULL
for(i in 1:length(crop_species)){
mod.gbm.xy[[i]] <- do_GBM(Training_xy[[i]])
print(crop_species[[i]])
print(mod.gbm.xy[[i]])

predictor.gbm.xy <- Predictor$new(model = mod.gbm.xy[[i]], data = Training_xy[[i]][-1], y = Training_xy[[i]]$Effect)

RMSEP_gbm_xy[[i]] <- do_iml_gbm(predictor.gbm.xy, mod.gbm.xy[[i]], Training_xy[[i]], Testing_xy[[i]], PlotTitle="Spatial GBM")
R2_gbm_xy[[i]] <- mod.gbm.xy[[i]][4]$results$Rsquared[which.min(mod.gbm.xy[[i]][4]$results$RMSE)]
}
```

###Climate RF
```{r climate-rf}
mod.rf.0 <- NULL
RMSEP_rf_0 <- NULL
R2_rf_0 <- NULL
Training_0 <- NULL
Training_2_bis <- NULL
Pred_rf_0 <- NULL
for(i in 1:length(crop_species)){
Training_0[[i]] <- Training_1[[i]][,-which(names(Training_1[[i]]) %in% c("Latitude","Longitude"))]

mod.rf.0[[i]] <- ranger(Effect~., data=Training_0[[i]], num.trees=1000)
print(crop_species[[i]])
print(mod.rf.0[[i]])

predictor.rf.0 <- Predictor$new(mod.rf.0[[i]], data = Training_0[[i]][-1], y = Training_0[[i]]$Effect, predict.fun = pfun)

RMSEP_rf_0[[i]] <- do_iml_rf(predictor.rf.0, mod.rf.0[[i]], Training_0[[i]], Testing_1[[i]], PlotTitle="Climate RF")
R2_rf_0[[i]] <- mod.rf.0[[i]]$r.squared

X0<- predict(mod.rf.0[[i]], data=Training_1[[i]])$predictions
Training_2_bis[[i]]<-cbind(Training_2[[i]],X0)
Pred_rf_0[[i]]<-predict(mod.rf.0[[i]], data=Testing_1[[i]])$predictions

if(do_iml){
imp <- FeatureImp$new(predictor.rf.0, loss = "mae")

#strength of interactions
interact <- Interaction$new(predictor.rf.0)

#specify two-way interactions
# interact <- Interaction$new(predictor, feature = "Longitude")
# plot(interact)

#feature effects
effs <- FeatureEffects$new(predictor.rf.0, method="pdp")

#WORKING nice plot, min maxs, combine?
efdf <- as.data.frame(rbind(effs$results$TempAvg, effs$results$Delta_temp, effs$results$CO2.ppm, effs$results$Adaptation))
names(efdf) <- c("VarValue","YieldChange","Method","Feature")
efdf$VarValue <- as.numeric(efdf$VarValue)
#ggplot(data=efdf, aes(x=VarValue, y=YieldChange)) + geom_line() + facet_wrap(.~Feature, nrow=2, scales = "free_x")
ylabs = "Yield Change"
ylims = range(efdf$YieldChange)+range(efdf$YieldChange)*0.1
layout.matrix <- matrix(c(1, 2, 3, 4), nrow = 1, ncol = 4)

pdf(file=paste0(crop_species[[i]]," PDPs.pdf"), height=2, width=8)
layout(mat = layout.matrix,
       heights = c(1,1,1,1), # Heights of the two rows
       widths = c(2.65,2,2,2)) # Widths of the two columns
#layout.show(4) 
par(oma=c(0,0,0,0)) # all sides have 3 lines of space
par(mar=c(5,5,0,0) + 0.1)
plot(effs$results$TempAvg$.borders, effs$results$TempAvg$.value, type = "l", ylab=ylabs, xlab=expression("Average Temperature"~degree~"C"), ylim=ylims)
par(mar=c(5,1,0,0) + 0.1)
plot(effs$results$Delta_temp$.borders, effs$results$Delta_temp$.value, type = "l", ylab="", xlab=expression(Delta~" Temperature"~degree~"C"), ylim=ylims, yaxt='n')
par(mar=c(5,1,0,0) + 0.1)
plot(effs$results$CO2.ppm$.borders, effs$results$CO2.ppm$.value, type = "l", ylab="", xlab=expression("CO"[2]~"ppm"), ylim=ylims, yaxt='n')
par(mar=c(5,1,0,0) + 0.1)
plot(effs$results$Adaptation$.borders, effs$results$Adaptation$.value, type = "l", ylab="", xlab="Adaptation", ylim=ylims, yaxt='n')
dev.off()

# #specify two-way interactions
# interact <- Interaction$new(predictor.rf.0, feature = "TempAvg")
# plot(interact)
# 
# eff <- FeatureEffect$new(predictor.rf.0, feature = c("TempAvg", "Delta_temp"), method="pdp")
# eff$plot()

# shapley <- NULL
# #WORKING write a loop around the shapley
# for (i in dim(Training_1)[1]){
# shapley[[i]] <- Shapley$new(predictor.rf.0 , x.interest = Training_0[i,-1])  
# }
}

}
```

###Climate GBM
```{r climate-gbm}
mod.gbm.0 <- NULL
RMSEP_gbm_0 <- NULL
R2_gbm_0 <- NULL
for(i in 1:length(crop_species)){
mod.gbm.0[[i]] <- do_GBM(Training_0[[i]])
print(crop_species[[i]])
print(mod.gbm.0[[i]])

predictor.gbm.0 <- Predictor$new(mod.gbm.0[[i]], data = Training_0[[i]][-1], y = Training_0[[i]]$Effect)

RMSEP_gbm_0[[i]] <- do_iml_gbm(predictor.gbm.0, mod.gbm.0[[i]], Training_0[[i]], Testing_1[[i]], PlotTitle="Climate GBM")
R2_gbm_0[[i]] <- mod.gbm.0[[i]][4]$results$Rsquared[which.min(mod.gbm.0[[i]][4]$results$RMSE)]
}
```

###Climate+longlat RF
```{r, climate-longlat-rf}
mod.rf.1 <- NULL
RMSEP_rf_1 <- NULL
R2_rf_1 <- NULL
for(i in 1:length(crop_species)){
set.seed(1234)
if(same_locations){
  mod.rf.1[[i]] <- ranger(Effect~., data=Training_1[[i]], num.trees=1000, importance="permutation")
} else {
  mod.rf.1[[i]] <- ranger(Effect~., data=Training_1[[i]], num.trees=1000)
}
print(crop_species[[i]])
print(mod.rf.1[[i]])

predictor.rf.1 <- Predictor$new(mod.rf.1[[i]], data = Training_1[[i]][-1], y = Training_1[[i]]$Effect, predict.fun = pfun)

RMSEP_rf_1[[i]] <- do_iml_rf(predictor.rf.1, mod.rf.1[[i]], Training_1[[i]], Testing_1[[i]], PlotTitle="Climate+LongLat RF")
R2_rf_1[[i]] <- mod.rf.1[[i]]$r.squared
}
```

###Climate+longlat GBM
```{r climate-longlat-gbm}
mod.gbm.1 <- NULL
RMSEP_gbm_1 <- NULL
R2_gbm_1 <- NULL
for(i in 1:length(crop_species)){
mod.gbm.1[[i]] <- do_GBM(Training_1[[i]])
print(crop_species[[i]])
print(mod.gbm.1[[i]])

predictor.gbm.1 <- Predictor$new(mod.gbm.1[[i]], data = Training_1[[i]][-1], y = Training_1[[i]]$Effect)

RMSEP_gbm_1[[i]] <- do_iml_gbm(predictor.gbm.1, mod.gbm.1[[i]], Training_1[[i]], Testing_1[[i]], PlotTitle="Climate+LongLat GBM")
R2_gbm_1[[i]] <- mod.gbm.1[[i]][4]$results$Rsquared[which.min(mod.gbm.1[[i]][4]$results$RMSE)]
}
```

##Mixed models
###Climate
```{r climate-lme}
mod_lm <- NULL
RMSEP_lm <- NULL
R2_lm <- NULL
for(i in 1:length(crop_species)){
#Linear model climate
if(same_locations){
  if(drop_future){
    mod_lm[[i]]<-lmer(Effect~Delta_temp+TempAvg+Adaptation+CO2.ppm+(1|Loca), data=Training_2[[i]])
  } else {
    mod_lm[[i]]<-lmer(Effect~Delta_temp+TempAvg+Adaptation+CO2.ppm+Future+(1|Loca), data=Training_2[[i]])
  }
} else {
  if(drop_future){
    mod_lm[[i]]<-lmer(Effect~Delta_temp+TempAvg+Adaptation+CO2.ppm+(1|Ref), data=Training_2[[i]])
  } else {
    mod_lm[[i]]<-lmer(Effect~Delta_temp+TempAvg+Adaptation+CO2.ppm+Future+(1|Ref), data=Training_2[[i]])
  }
}
print(crop_species[[i]])
print(summary(mod_lm[[i]]))

if(same_locations){
  Pred_lm<-predict(mod_lm[[i]], newdata=Testing_2[[i]])
} else {
  Pred_lm<-predict(mod_lm[[i]], newdata=Testing_2[[i]], re.form=NA)
}

RMSEP_lm[[i]]=sqrt(mean((Testing_2[[i]]$Effect-Pred_lm)^2))
print(plot(Testing_2[[i]]$Effect,Pred_lm))
#R2_lm[[i]] <- r.squaredGLMM(mod_lm[[i]])[1]
R2_lm[[i]] <- 1 - sum( (Testing_2[[i]]$Effect-Pred_lm)^2 ) / sum( (Testing_2[[i]]$Effect - mean(Testing_2[[i]]$Effect))^2 )
}
```

###Climate+Interactions
```{r climate-int-lme}
mod_lm_ints <- NULL
RMSEP_lm_ints <- NULL
R2_lm_ints <- NULL
for(i in 1:length(crop_species)){
#Linear model climate
if(same_locations){
  if(drop_future){ 
    mod_lm_ints[[i]]<-lmer(Effect~Delta_temp*CO2.ppm*Adaptation*TempAvg+(1|Loca), data=Training_2[[i]])
  } else {
    mod_lm_ints[[i]]<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Future*TempAvg + Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+(1|Loca), data=Training_2[[i]])
  }
} else {
  if(drop_future){
    mod_lm_ints[[i]]<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Delta_temp*TempAvg+Adaptation+CO2.ppm+(1|Ref), data=Training_2[[i]])
  } else {
    mod_lm_ints[[i]]<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Future*TempAvg + Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+(1|Ref), data=Training_2[[i]])
  }
}
print(crop_species[[i]])
print(summary(mod_lm_ints[[i]]))

if(same_locations){
  Pred_lm_ints<-predict(mod_lm_ints[[i]], newdata=Testing_2[[i]])
} else {
  Pred_lm_ints<-predict(mod_lm_ints[[i]], newdata=Testing_2[[i]], re.form=NA)
}

RMSEP_lm_ints[[i]]=sqrt(mean((Testing_2[[i]]$Effect-Pred_lm_ints)^2))
R2_lm_ints[[i]] <- 1 - sum( (Testing_2[[i]]$Effect-Pred_lm_ints)^2 ) / sum( (Testing_2[[i]]$Effect - mean(Testing_2[[i]]$Effect))^2 )
print(plot(Testing_2[[i]]$Effect,Pred_lm_ints))
#R2_lm_ints[[i]] <- r.squaredGLMM(mod_lm_ints[[i]])[2]
}
```

###Spatial
```{r spamm}
mod_spa_0 <- NULL
RMSEP_spa_0 <- NULL
R2_spa_0 <- NULL
for(i in 1:length(crop_species)){
#Spatial linear model
mod_spa_0[[i]]<-fitme(Effect~1+Matern(1|x+y), data=Training_2[[i]])
print(crop_species[[i]])
print(summary(mod_spa_0[[i]]))

Pred_spa_0<-predict(mod_spa_0[[i]], newdata=Testing_2[[i]])
RMSEP_spa_0[[i]]=sqrt(mean((Testing_2[[i]]$Effect-Pred_spa_0)^2))
print(plot(Testing_2[[i]]$Effect,Pred_spa_0))
R2_spa_0[[i]] <- 1 - sum( (Testing_2[[i]]$Effect-Pred_spa_0)^2 ) / sum( (Testing_2[[i]]$Effect - mean(Testing_2[[i]]$Effect))^2 )
}
```

###Spatial climate
```{r climate-co2-spamm}
mod_spa_lm <- NULL
RMSEP_spa_lm <- NULL
R2_spa_lm <- NULL
for(i in 1:length(crop_species)){
#Spatial linear model + climate + CO2
if(drop_future){
  mod_spa_lm[[i]]<-fitme(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+Matern(1|x+y), data=Training_2[[i]])
} else {
  mod_spa_lm[[i]]<-fitme(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+Matern(1|x+y), data=Training_2[[i]])
}
print(crop_species[[i]])
print(summary(mod_spa_lm[[i]]))

Pred_spa_lm<-predict(mod_spa_lm[[i]], newdata=Testing_2[[i]])
RMSEP_spa_lm[[i]]=sqrt(mean((Testing_2[[i]]$Effect-Pred_spa_lm)^2))
print(plot(Testing_2[[i]]$Effect,Pred_spa_lm))
R2_spa_lm[[i]] <- 1 - sum( (Testing_2[[i]]$Effect-Pred_spa_lm)^2 ) / sum( (Testing_2[[i]]$Effect - mean(Testing_2[[i]]$Effect))^2 )
}
```

###Spatial+RF outputs
```{r climate-rf-spamm}
mod_spa_rf <- NULL
RMSEP_spa_rf <- NULL
Testing_2_bis <- NULL
R2_spa_rf <- NULL
for(i in 1:length(crop_species)){
#Sptial linear model + RF outputs
mod_spa_rf[[i]]<-fitme(Effect~X0+Matern(1|x+y), data=Training_2_bis[[i]])
print(crop_species[[i]])
print(summary(mod_spa_rf[[i]]))

Testing_2_bis[[i]]<-cbind(Testing_2[[i]], X0=Pred_rf_0[[i]])
Pred_spa_rf<-predict(mod_spa_rf[[i]], newdata=Testing_2_bis[[i]])
RMSEP_spa_rf[[i]]=sqrt(mean((Testing_2_bis[[i]]$Effect-Pred_spa_rf)^2))
print(plot(Testing_2_bis[[i]]$Effect,Pred_spa_rf))
R2_spa_rf[[i]] <- 1 - sum( (Testing_2[[i]]$Effect-Pred_spa_rf)^2 ) / sum( (Testing_2[[i]]$Effect - mean(Testing_2[[i]]$Effect))^2 )
}
```

##Summarize RMSE
```{r}
NAME<-c("RF long lat","GBM long lat",
        "RF climate","GBM climate",
        "RF climate + long lat","GBM climate + long lat",
        "Linear model climate",
        "Linear model climate + interactions",
        "Spatial linear model","Spatial linear model + climate","Spatial linear model + RF outputs")

RESULT <- NULL
for(i in 1:length(crop_species)){
RMSEP <- c(RMSEP_rf_xy[[i]],RMSEP_gbm_xy[[i]],
RMSEP_rf_0[[i]],RMSEP_gbm_0[[i]],
RMSEP_rf_1[[i]],RMSEP_gbm_1[[i]],
RMSEP_lm[[i]],
RMSEP_lm_ints[[i]],
RMSEP_spa_0[[i]],
RMSEP_spa_lm[[i]],
RMSEP_spa_rf[[i]])

R2 <- c(R2_rf_xy[[i]],R2_gbm_xy[[i]],
R2_rf_0[[i]],R2_gbm_0[[i]],
R2_rf_1[[i]],R2_gbm_1[[i]],
R2_lm[[i]],
R2_lm_ints[[i]],
R2_spa_0[[i]],
R2_spa_lm[[i]],
R2_spa_rf[[i]])

RESULT[[i]]<-data.frame(NAME,RMSEP,R2)
print(crop_species[[i]])
print(RESULT[[i]])
write.csv(file=paste0(crop_species[[i]],"_stats.csv"),RESULT[[i]])
}

save.image(file="saved_MLs.RData")
```
#STOPPED HERE
#Generate maps
```{r}
#############################
######Projection mapping#####
#############################
thisone = 2
crop_species_map = crop_species[[thisone]]
Training_map = Training_1[[thisone]]
mod.rf.1.map <- mod.rf.1[[thisone]]

TAB_p<-read.csv(paste0(datadir,"tave_201120.csv"), header=T)
TAB_p<-na.omit(TAB_p)

#Filter by cropping areas
Area_crop<-read.csv(paste0(datadir,crop_species_map,"_country.csv"), header=T)

TAB_p_f<-right_join(Area_crop,TAB_p, by=c("x","y"))
TAB_p_f<-TAB_p_f[TAB_p_f$Total*TAB_p_f$Flag>0,]
N<-nrow(TAB_p_f)

N

# #Inputs for prediction
# #RCP8.5 w/o adaptation
# NewData<-data.frame(Delta_temp=rep(4, N),CO2.ppm=rep(448,N),Adaptation=as.factor(rep("No",N)),TempAvg=TAB_p_f$Tave, Latitude=TAB_p_f$y, Longitude=TAB_p_f$x, Future=rep(2089,N))
# M<-nrow(DATA)
# NewDataObs<-data.frame(Delta_temp=rep(4, M),CO2.ppm=rep(448,M),Adaptation=as.factor(rep("No",M)),TempAvg=DATA$TempAvg, Latitude=DATA$Latitude, Longitude=DATA$Longitude, Future=rep(2089,M))
# levels(NewData$Adaptation)=c("No","Yes")
# levels(NewDataObs$Adaptation)=c("No","Yes")

#390ppm is pre-industrial
#RCP4.5
NewData<-data.frame(Delta_temp=rep(2, N),CO2.ppm=rep(116,N),Adaptation=rep(1,N),TempAvg=TAB_p_f$Tave, Latitude=TAB_p_f$y, Longitude=TAB_p_f$x, Future=rep(2060,N))
M<-nrow(DATA)
#NewDataObs<-data.frame(Delta_temp=rep(2, M),CO2.ppm=rep(116,M),Adaptation=as.factor(rep(1,M)),TempAvg=DATA$TempAvg, Latitude=DATA$Latitude, Longitude=DATA$Longitude, Future=rep(2060,M))
#levels(NewData$Adaptation)=c("No","Yes")
#levels(NewDataObs$Adaptation)=c("No","Yes")

#WORKING predict one value - ok works with numbers, but doesn't seem to work with the data above, what gives??
 # mod.test <- ranger(Effect~., data=Training_map, num.trees=1000, importance="permutation")
 # predict(mod.test,data=data.frame(Delta_temp=c(0,0,0,0),CO2.ppm=c(500,500,500,500),Adaptation=c(1,2,"No","Yes"),TempAvg=c(8,8,8,8), Latitude=c(30,30,30,30), Longitude=c(110,110,110,110), Future=c(2100,2100,2100,2100)) )$predictions
 # summary(Training_map$Adaptation)
 # head(Training_map$Adaptation)
 # str(Training_map)
 # #as.factor("Yes","No") #2 = Yes, 1 = No (Yes is default??)
 # predict(mod.test,data=data.frame(Delta_temp=c(0),CO2.ppm=c(500),Adaptation=c(2),TempAvg=c(8), Latitude=c(30), Longitude=c(110), Future=c(2100)) )$predictions

#Prediction RF
Pred_rf<-predict(mod.rf.1.map,data=NewData)
#WORKING - below doesn't work right now, why??
#Pred_rf_obs<-predict(mod.rf.1.map,data=NewDataObs)

#Whole map
Pred=Pred_rf$predictions
Pred

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-Pred[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

summary(Pred)

#WORKING DIVERGING COLOR SCHEME!
pdf(file=paste0(crop_species_map,"rf_noadapt_rcp4.5.pdf"), height=8, width=8)
par(bty="n")
#par(fig=c(0,0.75,0.5,1))
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-80,40,by=5))
text(0,100, paste0(crop_species_map," with RCP 4.5"))
#text(0,100, paste0(crop_species_map," with +2Â°C +200ppm and adaptation"))
maps::map("world", add=T)
#points(DATA$Longitude, DATA$Latitude, pch=19, col="red")
dev.off()

par(mfrow=c(1,1))
AreaOrder<-TAB_p_f$Total[order(Pred)]
PropArea<-100*cumsum(AreaOrder)/max(cumsum(AreaOrder))
#par(fig=c(0.9,1,0.5,1))
plot(Pred[order(Pred)], PropArea,xlab="Yield change (%)", ylab="Cumulative area proportion (%)", col="darkgreen", lwd=3, lty=2, type="l", xlim=c(-70, 50))
abline(v=seq(-70,40,by=10),h=seq(0,100,by=10), lty=3, lwd=0.5)
abline(v=0, lwd=0.5)
abline(h=50, lwd=0.5)
text(-40,95, paste(round(median(Pred),2), " (", round(quantile(Pred,0.025),2), ", ", round(quantile(Pred,0.975),2), ")", sep=""), cex=1, font=2, col="darkgreen")

#Only observed locations
#Pred_obs<-Pred_rf_obs$predictions
# PropLocation<-100*cumsum(rep(1,M))/M
# lines(Pred_obs[order(Pred_obs)], PropLocation, col="red")
# text(-40,90, paste(round(median(Pred_obs),2), " (", round(quantile(Pred_obs,0.025),2), ", ", round(quantile(Pred_obs,0.975),2), ")", sep=""), cex=1, font=2, col="red")
```

#Shapley on min and max values with DALEX
```{r}
#WHEN GENERALEIZE FIX FINDING MEAN!!!
set.seed(1234)
summary(Training_map$Effect)
Training_map[which.max(Training_map$Effect),]
Training_map[which.min(Training_map$Effect),]

explain_rf <- DALEX::explain(model = mod.rf.1.map,  
                        data = Training_map,
                           y = Training_map$Effect, 
                       label = "Random Forest")
predict(explain_rf, Training_map[which.max(Training_map$Effect),])
predict(explain_rf, Training_map[which.min(Training_map$Effect),])

shap_min <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_map[which.min(Training_map$Effect),-1], 
                                 type = "shap",
                                    B = 25)
shap_max <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_map[which.max(Training_map$Effect),-1], 
                                 type = "shap",
                                    B = 25)
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_map[36,-1], 
                                 type = "shap",
                                    B = 25)

pdf(file=paste0(crop_species_map,"_shapmin_dat.pdf"), height=3, width=4)
plot(shap_min)
dev.off()
pdf(file=paste0(crop_species_map,"_shapmax_dat.pdf"), height=3, width=4)
plot(shap_max)
dev.off()
pdf(file=paste0(crop_species_map,"_shapmean_dat.pdf"), height=3, width=4)
plot(shap_mean)
dev.off()

plot(shap_min)
plot(shap_max)
plot(shap_mean)

NewData$Effect <- predict(explain_rf, NewData)

##RCP 4.5, No Adaptation
if(drop_future){
  NewRCP <- NewData[which.min(NewData$Effect),-c(7,8)]
} else {
  NewRCP <- NewData[which.min(NewData$Effect),-c(8)]
}

shap_min <- predict_parts(explainer = explain_rf, 
                      new_observation = NewRCP, 
                                 type = "shap",
                                    B = 25)
shap_max <- predict_parts(explainer = explain_rf, 
                      new_observation = NewRCP, 
                                 type = "shap",
                                    B = 25)
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewRCP, 
                                 type = "shap",
                                    B = 25)

pdf(file=paste0(crop_species_map,"_shapmin_RCP.pdf"), height=3, width=4)
plot(shap_min)
dev.off()
pdf(file=paste0(crop_species_map,"_shapmax_RCP.pdf"), height=3, width=4)
plot(shap_max)
dev.off()
pdf(file=paste0(crop_species_map,"_shapmean_RCP.pdf"), height=3, width=4)
plot(shap_mean)
dev.off()

plot(shap_min)
plot(shap_max)
plot(shap_mean)
```

#Shapmap Dat
##Mean Shapley values for mapping CO2ppm
```{r, eval=F}
set.seed(1234)

explain_rf <- DALEX::explain(model = mod.rf.1.map,  
                        data = Training_map,
                           y = Training_map$Effect, 
                       label = "Random Forest")

#0.17 minutes for 1 row, or 10 seconds
shap_co2ppm <- vector(length=dim(Training_map)[1])
start.time <- Sys.time()
for (i in 1:10){ #dim(Training_map)[1]
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_map[i,-1], 
                                 type = "shap",
                                    B = 25)
shap_co2ppm[i] <- shap_mean[shap_mean$variable_name=="CO2.ppm",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

#time for temp_avg
shap_temp <- vector(length=dim(Training_map)[1])
start.time <- Sys.time()
for (i in 1:1){ #dim(Training_map)[1]
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_map[i,-1], 
                                 type = "shap",
                                    B = 1)
shap_temp[i] <- shap_mean[shap_mean$variable_name=="TempAvg",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

NewData <- Training_map
NewData$shap_co2ppm <- shap_co2ppm

##Shap map plot
pdf(file=paste0(crop_species_map,"_shapmap.pdf"), height=8, width=8)
maps::map("world")
points(NewData$Longitude, NewData$Latitude, pch=19, col=NewData$CO2.ppm, cex=0.5)
text(0,100, paste0(crop_species_map," Shapley CO2ppm"))
dev.off()

#Then most important Shapley for each grid cell (must compute all)
```

#Shapmap RCP 4.5
##Prep shapmap data
```{r}
#RCP4.5
NewData<-data.frame(Delta_temp=rep(2, N),CO2.ppm=rep(116,N),Adaptation=as.factor(rep(1,N)),TempAvg=TAB_p_f$Tave, Latitude=TAB_p_f$y, Longitude=TAB_p_f$x, Future=rep(2060,N))
M<-nrow(DATA)
NewDataObs<-data.frame(Delta_temp=rep(2, M),CO2.ppm=rep(116,M),Adaptation=as.factor(rep(1,M)),TempAvg=DATA$TempAvg, Latitude=DATA$Latitude, Longitude=DATA$Longitude, Future=rep(2060,M))
levels(NewData$Adaptation)=c("No","Yes")
levels(NewDataObs$Adaptation)=c("No","Yes")

#Prediction RF
Pred_rf<-predict(mod.rf.1.map,data=NewData)
#Pred_rf_obs<-predict(mod.rf.1.map,data=NewDataObs)

#Whole map
Pred=Pred_rf$predictions
NewData$Effect <- Pred

#Do the Shap part
set.seed(1234)

if(drop_future){
  NewData <- NewData[,-c(7)]
}

explain_rf <- DALEX::explain(model = mod.rf.1.map,  
                        data = Training_map,
                           y = Training_map$Effect, 
                       label = "Random Forest")
```

##CO2ppm
```{r}
#3.5 hours
shap_co2ppm <- vector(length=dim(NewData)[1])
start.time <- Sys.time()
for (i in 1:dim(NewData)[1]){
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewData[i,-7], 
                                 type = "shap",
                                    B = 1)
shap_co2ppm[i] <- shap_mean[shap_mean$variable_name=="CO2.ppm",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

save(shap_co2ppm, file="shap_co2ppm_4.5.RData")

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-shap_co2ppm[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_co2ppm.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-1,2.4,by=0.15))
text(0,100, paste0("CO2 ppm ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()

```

##TempAvg
```{r}
shap_TempAvg <- vector(length=dim(NewData)[1])
start.time <- Sys.time()
for (i in 1:dim(NewData)[1]){
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewData[i,-7], 
                                 type = "shap",
                                    B = 1)
shap_TempAvg[i] <- shap_mean[shap_mean$variable_name=="TempAvg",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

save(shap_TempAvg, file="shap_TempAvg_4.5.RData")

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-shap_TempAvg[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_TempAvg.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-26,14,by=3))
text(0,100, paste0("Avg temperature ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()

```


##Delta_temp
```{r}
#3.5 hours
shap_Delta_temp <- vector(length=dim(NewData)[1])
start.time <- Sys.time()
for (i in 1:dim(NewData)[1]){
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewData[i,-7], 
                                 type = "shap",
                                    B = 1)
shap_Delta_temp[i] <- shap_mean[shap_mean$variable_name=="Delta_temp",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

save(Delta_temp, file="shap_Delta_temp_4.5.RData")

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-shap_Delta_temp[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_Delta_temp.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-5,4,by=1))
text(0,100, paste0("Delta temperature ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()
```

##Adaptation
```{r}
#3.5 hours
shap_Adaptation <- vector(length=dim(NewData)[1])
start.time <- Sys.time()
for (i in 1:dim(NewData)[1]){
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewData[i,-7], 
                                 type = "shap",
                                    B = 1)
shap_Adaptation[i] <- shap_mean[shap_mean$variable_name=="Adaptation",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

save(Adaptation, file="shap_Adaptation_4.5.RData")

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-shap_Adaptation[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_Adaptation.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-12,5,by=2))
text(0,100, paste0("Adaptation ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()

```

#Set up the ternary
```{r}
shap_temps <- shap_TempAvg + shap_Delta_temp
shap_co2ppm
shap_Adaptation

shaps <- cbind(abs(shap_temps), abs(shap_co2ppm), abs(shap_Adaptation))
colnames(shaps) <- c("Temperature","CO2ppm","Adaptation")

maxshaps <- colnames(shaps)[apply(shaps,1,which.max)]
maxshaps.num <- NULL
for(i in 1:length(maxshaps)){
maxshaps.num[i] <- ifelse(maxshaps[i]=="Temperature",-1, ifelse(maxshaps[i]=="CO2ppm", 0, ifelse (maxshaps[i]=="Adaptation", 1, NA) ))}

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-maxshaps.num[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_max.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(4)), breaks=seq(-1,1,by=0.5))
text(0,100, paste0("Max absolute shapley value ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()
#Temp -1, CO2ppm 0, Adaptation 1

pdf(file="shapley_histograms.pdf", height=5, width=5)
par(mfrow=c(2,2))
hist(shap_temps, main="Temperature", xlab="Shapley Value")
hist(shap_co2ppm, main="CO2 ppm", xlab="Shapley Value")
hist(shap_Adaptation, main="Adaptation", xlab="Shapley Value")
dev.off()
```




#Yield gain ternary
```{r}
shap_temps <- shap_TempAvg + shap_Delta_temp
shap_co2ppm
shap_Adaptation

shaps <- cbind(shap_temps, shap_co2ppm, shap_Adaptation)
colnames(shaps) <- c("Temperature","CO2ppm","Adaptation")

maxshaps <- colnames(shaps)[apply(shaps,1,which.max)]
maxshaps.num <- NULL
for(i in 1:length(maxshaps)){
maxshaps.num[i] <- ifelse(maxshaps[i]=="Temperature",-1, ifelse(maxshaps[i]=="CO2ppm", 0, ifelse (maxshaps[i]=="Adaptation", 1, NA) ))}

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-maxshaps.num[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_max_gain.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(4)), breaks=seq(-1,1,by=0.5))
text(0,100, paste0("Max shapley value ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()
#Temp -1, CO2ppm 0, Adaptation 1

```


#Yield loss ternary
```{r}
shap_temps <- shap_TempAvg + shap_Delta_temp
shap_co2ppm
shap_Adaptation

shaps <- cbind(shap_temps, shap_co2ppm, shap_Adaptation)
colnames(shaps) <- c("Temperature","CO2ppm","Adaptation")

maxshaps <- colnames(shaps)[apply(shaps,1,which.min)]
maxshaps.num <- NULL
for(i in 1:length(maxshaps)){
maxshaps.num[i] <- ifelse(maxshaps[i]=="Temperature",-1, ifelse(maxshaps[i]=="CO2ppm", 0, ifelse (maxshaps[i]=="Adaptation", 1, NA) ))}

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-maxshaps.num[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species_map,"_rcp4.5_shapmap_max_loss.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(4)), breaks=seq(-1,1,by=0.5))
text(0,100, paste0("Min shapley value ",crop_species_map," with RCP 4.5"))
maps::map("world", add=T)
dev.off()
#Temp -1, CO2ppm 0, Adaptation 1

```
