---
title: "Yield_analysis"
output: html_document
---
```
####David Makowski INRAE###
####18/02/2021####
#Edited by Rose Abramoff - starting 22/02/2021
```
```{r global-options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res)
    }
  }
}))
knitr::opts_chunk$set(time_it = TRUE)
```

#Load libraries
```{r load-libraries}
library(openxlsx)
library(raster)
library(rgdal)
library(rgeos)
library(maps)
library(mapdata)
library(dplyr)
library(lme4)
library(lmerTest)
library(spaMM)
library(ranger)
library(ggplot2)
library(pdp)
library(caret)
library(iml)
library(randomForest)
library(gbm)
library(DALEX)
```

#Switches
```{r switches}
same_locations = T #default is same locations
drop_future = T
crop_species = "Soybean" #Maize Rice Soybean Wheat
do_iml = F
```

#Data import
```{r data-import}
datadir <- "/Users/rzabramoff/ownCloud/Professional Dev/Makowski_yield/Data/"
TAB<-read.xlsx(paste0(datadir,"Projected_Impacts_datasheet_1.3.xlsx"), sheet=1)
head(TAB)

#Extraction of columns
Species<-as.factor(TAB$Crop)
Ref<-TAB$Ref.No.
Sample<-TAB$Sample.No.
Delta_temp<-as.numeric(TAB$Global.delta.T.from.2005)
Effect<-as.numeric(TAB$"Climate.impacts.relative.to.2005.(%)")
CO2<-TAB$CO2
CO2[CO2=="Yes" | CO2=="yes"]<-"Yes"
CO2[CO2=="No"]<-"No"
CO2<-as.factor(CO2)
CO2.ppm<-TAB$CO2.ppm-390
CO2.ppm[CO2=="No"]<-0
Adaptation<-as.factor(TAB$Adaptation)
RCP<-as.factor(TAB$RCP.Scenarios)
TempAvg<-as.numeric(TAB$Current.Average.Temperature)
Latitude<-TAB$latitude
Longitude<-TAB$longitude
Baseline<-TAB$"Baseline_Mid-point"
Future<-TAB$"Future_Mid-point"
Future_s<-scale(Future)
```

#Choose crop and prep
```{r, choose-crop}
if(same_locations){
  Loca<-paste(Longitude,Latitude, sep="_") 
  if(drop_future){
    DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, y=Latitude, x=Longitude, Loca)
  }else{
    DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Future, y=Latitude, x=Longitude, Loca)
    }
} else {
    if(drop_future){
      DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, y=Latitude, x=Longitude)
    }else{
      DATA_lm<-data.frame(Ref,Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Future, y=Latitude, x=Longitude)
    }
}

if(drop_future){
  DATA<-data.frame(Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Latitude, Longitude)
} else {
  DATA<-data.frame(Effect,Species,Delta_temp,CO2.ppm,Adaptation,TempAvg, Future, Latitude, Longitude)
}

DATA<-DATA[DATA$Species==crop_species,]
DATA<-na.omit(DATA)
DATA_lm<-DATA_lm[DATA_lm$Species==crop_species,]
DATA_lm<-na.omit(DATA_lm)

#Remove Species
DATA<-DATA[ , -which(names(DATA) %in% c("Species"))]
summary(DATA)
DATA_lm<-DATA_lm[ , -which(names(DATA_lm) %in% c("Species"))]
summary(DATA_lm)

#Only x and y
DATA_xy<-DATA[ , which(names(DATA) %in% c("Effect","Latitude","Longitude"))]

#Map of data
par(mfrow=c(1,1))
maps::map("world")
points(DATA$Longitude, DATA$Latitude, pch=19, col="blue", cex=0.6)
points(DATA$Longitude[DATA$Effect>0], DATA$Latitude[DATA$Effect>0], pch=19, col="green", cex=0.6)
points(DATA$Longitude[DATA$Effect<(-25)], DATA$Latitude[DATA$Effect<(-25)], pch=19, col="orange", cex=0.6)
points(DATA$Longitude[DATA$Effect<(-50)], DATA$Latitude[DATA$Effect<(-50)], pch=19, col="red", cex=0.6)
```

#Analysis
##Splitting data
```{r prep-data}
set.seed(1234)
Loc<-paste(DATA$Longitude,DATA$Latitude, sep="_")

  #Split at the same locations
if(same_locations){
  ID<-1:length(Loc)
  DATA_sample<-cbind(ID,Loc,DATA)
  #Remove locations including one data only
  Loc_1<-names(table(DATA_sample$Loc))[as.numeric(table(DATA_sample$Loc))<2]
  DATA_sample2<-DATA_sample
  if (length(Loc_1)>1) {
    ID_1<-ID[DATA_sample$Loc%in%Loc_1==TRUE]
    DATA_sample2<-DATA_sample[-ID_1,]}
    #Sample one data per location
    new_data <- DATA_sample2 %>% group_by(Loc) %>% sample_n(1)
    ID<-new_data$ID
} else {
  #Split using different locations
  Loc<-paste(DATA$Longitude,DATA$Latitude, sep="_")
  UnLoc<-unique(Loc)
  ID_loc<-sample(x=UnLoc, size=round(0.25*length(UnLoc)))
  ID<-(1:nrow(DATA))[Loc%in%ID_loc==TRUE]
}

Training_xy<-DATA_xy[-ID,]
Testing_xy<-DATA[ID,]
Training_1<-DATA[-ID,]
Testing_1<-DATA[ID,]
Training_2<-DATA_lm[-ID,]
Testing_2<-DATA_lm[ID,]

#Map of data
par(mfrow=c(1,1))
maps::map("world")
points(Training_1$Longitude, Training_1$Latitude, pch=19, col="red", cex=0.5)
points(Testing_1$Longitude, Testing_1$Latitude, pch=19, col="blue", cex=0.25)
```

##ML functions
```{r, ml-functions}
do_GBM <- function(mldfTrain){
fitControl <- caret::trainControl( #10 fold CV
  method = "repeatedcv",
  number = 10,
  repeats = 10 )
set.seed(1234)
gbmFit1 <- caret::train( Effect ~ ., data = mldfTrain,
                    method = "gbm",
                    trControl = fitControl,
                    verbose = FALSE )
return(gbmFit1)
}

pfun <- function(object, newdata) predict(object, data = newdata)$predictions

do_iml_rf <- function(predictor, mod_ml, Training, Testing, PlotTitle){
  
if(do_iml){
imp <- FeatureImp$new(predictor, loss = "mae")

#strength of interactions
interact <- Interaction$new(predictor)

#specify two-way interactions
# interact <- Interaction$new(predictor, feature = "Longitude")
# plot(interact)

#feature effects
effs <- FeatureEffects$new(predictor, method="pdp")
#plot(effs$results$Latitude$.borders, effs$results$Latitude$.value, type="l") #can recreate to rename y ax but not sure how to recreate rug

#shapley
shapley <- Shapley$new(predictor, x.interest = Training[1,-1])

#plots
print(plot(imp) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(interact) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(effs) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(shapley$plot() + ggtitle(paste0(PlotTitle," ",crop_species)))
}

Pred_ml<-predict(mod_ml, data=Testing)$predictions
RMSEP_ml=sqrt(mean((Testing$Effect-Pred_ml)^2))
return(RMSEP_ml)
}

do_iml_gbm <- function(predictor, mod_ml, Training, Testing, PlotTitle){
imp <- FeatureImp$new(predictor, loss = "mae")

#strength of interactions
interact <- Interaction$new(predictor)

#specify two-way interactions
# interact <- Interaction$new(predictor, feature = "Longitude")
# plot(interact)

#feature effects
effs <- FeatureEffects$new(predictor, method="pdp")
#plot(effs$results$Latitude$.borders, effs$results$Latitude$.value, type="l") #can recreate to rename y ax but not sure how to recreate rug

#shapley
shapley <- Shapley$new(predictor, x.interest = Training[1,-1])

#plots
print(plot(imp) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(interact) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(plot(effs) + ggtitle(paste0(PlotTitle," ",crop_species)))
print(shapley$plot() + ggtitle(paste0(PlotTitle," ",crop_species)))

Pred_ml<-predict(mod_ml, newdata=Testing)
RMSEP_ml=sqrt(mean((Testing$Effect-Pred_ml)^2))
return(RMSEP_ml)
}
```

##Random Forests and GBM
###Spatial RF
```{r spatial-rf}
set.seed(1234)
mod.rf.xy <- ranger(Effect~., data=Training_xy, num.trees=1000)
mod.rf.xy

predictor.rf.xy <- Predictor$new(model = mod.rf.xy, data = Training_xy[-1], y = Training_xy$Effect, predict.fun = pfun)

RMSEP_rf_xy <- do_iml_rf(predictor.rf.xy, mod.rf.xy, Training_xy, Testing_xy, PlotTitle="Spatial RF")
```

###Spatial GBM
```{r, spatial-gbm}
mod.gbm.xy <- do_GBM(Training_xy)
mod.gbm.xy

predictor.gbm.xy <- Predictor$new(model = mod.gbm.xy, data = Training_xy[-1], y = Training_xy$Effect)

RMSEP_gbm_xy <- do_iml_gbm(predictor.gbm.xy, mod.gbm.xy, Training_xy, Testing_xy, PlotTitle="Spatial GBM")
```

###Climate RF
```{r climate-rf}
Training_0 <- Training_1[,-which(names(Training_1) %in% c("Latitude","Longitude"))]

mod.rf.0 <- ranger(Effect~., data=Training_0, num.trees=1000)
mod.rf.0

predictor.rf.0 <- Predictor$new(mod.rf.0, data = Training_0[-1], y = Training_0$Effect, predict.fun = pfun)

RMSEP_rf_0 <- do_iml_rf(predictor.rf.0, mod.rf.0, Training_0, Testing_1, PlotTitle="Climate RF")

X0<- predict(mod.rf.0, data=Training_1)$predictions
Training_2_bis<-cbind(Training_2,X0)
Pred_rf_0<-predict(mod.rf.0, data=Testing_1)$predictions

# #specify two-way interactions
# interact <- Interaction$new(predictor.rf.0, feature = "TempAvg")
# plot(interact)
# 
# eff <- FeatureEffect$new(predictor.rf.0, feature = c("TempAvg", "Delta_temp"), method="pdp")
# eff$plot()

# shapley <- NULL
# #WORKING write a loop around the shapley
# for (i in dim(Training_1)[1]){
# shapley[[i]] <- Shapley$new(predictor.rf.0 , x.interest = Training_0[i,-1])  
# }
```

###Climate GBM
```{r climate-gbm}
mod.gbm.0 <- do_GBM(Training_0)
mod.gbm.0

predictor.gbm.0 <- Predictor$new(mod.gbm.0, data = Training_0[-1], y = Training_0$Effect)

RMSEP_gbm_0 <- do_iml_gbm(predictor.gbm.0, mod.gbm.0, Training_0, Testing_1, PlotTitle="Climate GBM")
```

###Climate+longlat RF
```{r, climate-longlat-rf}
set.seed(1234)
if(same_locations){
  mod.rf.1 <- ranger(Effect~., data=Training_1, num.trees=1000, importance="permutation")
} else {
  mod.rf.1 <- ranger(Effect~., data=Training_1, num.trees=1000)
}
mod.rf.1

predictor.rf.1 <- Predictor$new(mod.rf.1, data = Training_1[-1], y = Training_1$Effect, predict.fun = pfun)

RMSEP_rf_1 <- do_iml_rf(predictor.rf.1, mod.rf.1, Training_1, Testing_1, PlotTitle="Climate+LongLat RF")
```

###Climate+longlat GBM
```{r climate-longlat-gbm}
mod.gbm.1 <- do_GBM(Training_1)
mod.gbm.1

predictor.gbm.1 <- Predictor$new(mod.gbm.1, data = Training_1[-1], y = Training_1$Effect)

RMSEP_gbm_1 <- do_iml_gbm(predictor.gbm.1, mod.gbm.1, Training_1, Testing_1, PlotTitle="Climate+LongLat GBM")
```

##Mixed models
###Climate-+CO2
```{r climate-lme}
#Linear model climate - CO2
#Linear model climate + CO2
if(same_locations){
  if(drop_future){
      mod_noco2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+(1|Loca), data=Training_2)  
    mod_co2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+(1|Loca), data=Training_2)
  } else {
    mod_noco2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+Future+(1|Loca), data=Training_2)  
    mod_co2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+(1|Loca), data=Training_2)
  }
} else {
  if(drop_future){
      mod_noco2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+(1|Ref), data=Training_2)
    mod_co2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+(1|Ref), data=Training_2)
  } else {
    mod_noco2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+Future+(1|Ref), data=Training_2)
    mod_co2<-lmer(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+(1|Ref), data=Training_2)
  }
}
summary(mod_noco2)
summary(mod_co2)

if(same_locations){
  Pred_noco2<-predict(mod_noco2, newdata=Testing_2)
  Pred_co2<-predict(mod_co2, newdata=Testing_2)
} else {
  Pred_noco2<-predict(mod_noco2, newdata=Testing_2, re.form=NA)
  Pred_co2<-predict(mod_co2, newdata=Testing_2, re.form=NA)
}

RMSEP_lm_noco2=sqrt(mean((Testing_2$Effect-Pred_noco2)^2))
RMSEP_lm_co2=sqrt(mean((Testing_2$Effect-Pred_co2)^2))
```

###Climate-+CO2+Interactions
```{r climate-int-lme}
#Linear model climate - CO2
#Linear model climate + CO2
if(same_locations){
  if(drop_future){ 
    mod_noco2_ints<-lmer(Effect~ Delta_temp*Adaptation + Delta_temp*TempAvg+Adaptation+(1|Loca), data=Training_2)  
    mod_co2_ints<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Delta_temp*TempAvg+Adaptation+CO2.ppm+(1|Loca), data=Training_2)
  } else {
    mod_noco2_ints<-lmer(Effect~ Delta_temp*Adaptation + Future*TempAvg + Delta_temp*TempAvg+Adaptation+Future+(1|Loca), data=Training_2)  
    mod_co2_ints<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Future*TempAvg + Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+(1|Loca), data=Training_2)
  }
} else {
  if(drop_future){
    mod_noco2_ints<-lmer(Effect~Delta_temp*Adaptation + Delta_temp*TempAvg+Adaptation+(1|Ref), data=Training_2)
    mod_co2_ints<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Delta_temp*TempAvg+Adaptation+CO2.ppm+(1|Ref), data=Training_2)
  } else {
    mod_noco2_ints<-lmer(Effect~Delta_temp*Adaptation + Future*TempAvg + Delta_temp*TempAvg+Adaptation+Future+(1|Ref), data=Training_2)
    mod_co2_ints<-lmer(Effect~Delta_temp*CO2.ppm + Delta_temp*Adaptation + Future*TempAvg + Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+(1|Ref), data=Training_2)
  }
}
summary(mod_noco2_ints)
summary(mod_co2_ints)

if(same_locations){
  Pred_noco2_ints<-predict(mod_noco2_ints, newdata=Testing_2)
  Pred_co2_ints<-predict(mod_co2_ints, newdata=Testing_2)
} else {
  Pred_noco2_ints<-predict(mod_noco2_ints, newdata=Testing_2, re.form=NA)
  Pred_co2_ints<-predict(mod_co2_ints, newdata=Testing_2, re.form=NA)
}

RMSEP_lm_noco2_ints=sqrt(mean((Testing_2$Effect-Pred_noco2_ints)^2))
RMSEP_lm_co2_ints=sqrt(mean((Testing_2$Effect-Pred_co2_ints)^2))
```

###Spatial
```{r spamm}
#Spatial linear model
mod_spa_0<-fitme(Effect~1+Matern(1|x+y), data=Training_2)
summary(mod_spa_0)

Pred_spa_0<-predict(mod_spa_0, newdata=Testing_2)
RMSEP_spa_0=sqrt(mean((Testing_2$Effect-Pred_spa_0)^2))
```

###Spatial climate -CO2
```{r climate-spamm}
#Spatial linear model + climate - CO2
if(drop_future){
  mod_spa_noco2<-fitme(Effect~Delta_temp*TempAvg+Adaptation+Matern(1|x+y), data=Training_2)
} else {
  mod_spa_noco2<-fitme(Effect~Delta_temp*TempAvg+Adaptation+Future+Matern(1|x+y), data=Training_2)
}

summary(mod_spa_noco2)

Pred_spa_noco2<-predict(mod_spa_noco2, newdata=Testing_2)
RMSEP_spa_noco2=sqrt(mean((Testing_2$Effect-Pred_spa_noco2)^2))
```

###Spatial climate +CO2
```{r climate-co2-spamm}
#Spatial linear model + climate + CO2
if(drop_future){
  mod_spa_co2<-fitme(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+Matern(1|x+y), data=Training_2)
} else {
  mod_spa_co2<-fitme(Effect~Delta_temp*TempAvg+Adaptation+CO2.ppm+Future+Matern(1|x+y), data=Training_2)
}
  summary(mod_spa_co2)

Pred_spa_co2<-predict(mod_spa_co2, newdata=Testing_2)
RMSEP_spa_co2=sqrt(mean((Testing_2$Effect-Pred_spa_co2)^2))
```

###Spatial+RF outputs
```{r climate-rf-spamm}
#Sptial linear model + RF outputs
mod_spa_rf<-fitme(Effect~X0+Matern(1|x+y), data=Training_2_bis)
summary(mod_spa_rf)

Testing_2_bis<-cbind(Testing_2, X0=Pred_rf_0)
Pred_spa_rf<-predict(mod_spa_rf, newdata=Testing_2_bis)
RMSEP_spa_rf=sqrt(mean((Testing_2_bis$Effect-Pred_spa_rf)^2))
```

##Summarize RMSE
```{r}
NAME<-c("RF long lat","GBM long lat",
        "RF climate","GBM climate",
        "RF climate + long lat","GBM climate + long lat",
        "Linear model climate - CO2","Linear model climate + CO2",
        "Linear model climate - CO2 interactions","Linear model climate + CO2 interactions",
        "Spatial linear model","Spatial linear model + climate - CO2","Spatial linear model + climate + CO2","Spatial linear model + RF outputs")

RMSEP <- c(RMSEP_rf_xy,RMSEP_gbm_xy,
RMSEP_rf_0,RMSEP_gbm_0,
RMSEP_rf_1,RMSEP_gbm_1,
RMSEP_lm_noco2,RMSEP_lm_co2,
RMSEP_lm_noco2_ints,RMSEP_lm_co2_ints,
RMSEP_spa_0,
RMSEP_spa_noco2,
RMSEP_spa_co2,
RMSEP_spa_rf)

RESULT<-data.frame(NAME,RMSEP)
RESULT
```

#Generate maps
```{r}
#############################
######Projection mapping#####
#############################

TAB_p<-read.csv(paste0(datadir,"tave_201120.csv"), header=T)
TAB_p<-na.omit(TAB_p)

#Filter by cropping areas
Area_crop<-read.csv(paste0(datadir,crop_species,"_country.csv"), header=T)

TAB_p_f<-right_join(Area_crop,TAB_p, by=c("x","y"))
TAB_p_f<-TAB_p_f[TAB_p_f$Total*TAB_p_f$Flag>0,]
N<-nrow(TAB_p_f)

# #Inputs for prediction
# #RCP8.5 w/o adaptation
# NewData<-data.frame(Delta_temp=rep(4, N),CO2.ppm=rep(448,N),Adaptation=as.factor(rep("No",N)),TempAvg=TAB_p_f$Tave, Latitude=TAB_p_f$y, Longitude=TAB_p_f$x, Future=rep(2089,N))
# M<-nrow(DATA)
# NewDataObs<-data.frame(Delta_temp=rep(4, M),CO2.ppm=rep(448,M),Adaptation=as.factor(rep("No",M)),TempAvg=DATA$TempAvg, Latitude=DATA$Latitude, Longitude=DATA$Longitude, Future=rep(2089,M))
# levels(NewData$Adaptation)=c("No","Yes")
# levels(NewDataObs$Adaptation)=c("No","Yes")

#RCP4.5
NewData<-data.frame(Delta_temp=rep(2, N),CO2.ppm=rep(116,N),Adaptation=as.factor(rep("No",N)),TempAvg=TAB_p_f$Tave, Latitude=TAB_p_f$y, Longitude=TAB_p_f$x, Future=rep(2060,N))
M<-nrow(DATA)
NewDataObs<-data.frame(Delta_temp=rep(2, M),CO2.ppm=rep(116,M),Adaptation=as.factor(rep("No",M)),TempAvg=DATA$TempAvg, Latitude=DATA$Latitude, Longitude=DATA$Longitude, Future=rep(2060,M))
levels(NewData$Adaptation)=c("No","Yes")
levels(NewDataObs$Adaptation)=c("No","Yes")

#WORKING predict one value - ok works with numbers, but doesn't seem to work with the data above, what gives??
mod.test <- ranger(Effect~., data=Training_1, num.trees=1000, importance="permutation")
predict(mod.test,data=data.frame(Delta_temp=c(0,0,0,0),CO2.ppm=c(500,500,500,500),Adaptation=c(1,2,"No","Yes"),TempAvg=c(8,8,8,8), Latitude=c(30,30,30,30), Longitude=c(110,110,110,110), Future=c(2100,2100,2100,2100)) )$predictions
summary(Training_1$Adaptation)
head(Training_1$Adaptation)
str(Training_1)
#as.factor("Yes","No") #2 = Yes, 1 = No (Yes is default??)

#Prediction RF
Pred_rf<-predict(mod.rf.1,data=NewData)
Pred_rf_obs<-predict(mod.rf.1,data=NewDataObs)

#Whole map
Pred=Pred_rf$predictions

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-Pred[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

summary(Pred)

pdf(file=paste0(crop_species,"_rcp4.5.pdf"), height=8, width=8)
par(bty="n")
#par(fig=c(0,0.75,0.5,1))
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-80,40,by=5))
text(0,100, paste0(crop_species," with RCP 4.5"))
#text(0,100, paste0(crop_species," with +2Â°C +200ppm and adaptation"))
maps::map("world", add=T)
#points(DATA$Longitude, DATA$Latitude, pch=19, col="red")
dev.off()

par(mfrow=c(1,1))
AreaOrder<-TAB_p_f$Total[order(Pred)]
PropArea<-100*cumsum(AreaOrder)/max(cumsum(AreaOrder))
#par(fig=c(0.9,1,0.5,1))
plot(Pred[order(Pred)], PropArea,xlab="Yield change (%)", ylab="Cumulative area proportion (%)", col="darkgreen", lwd=3, lty=2, type="l", xlim=c(-70, 50))
abline(v=seq(-70,40,by=10),h=seq(0,100,by=10), lty=3, lwd=0.5)
abline(v=0, lwd=0.5)
abline(h=50, lwd=0.5)
text(-40,95, paste(round(median(Pred),2), " (", round(quantile(Pred,0.025),2), ", ", round(quantile(Pred,0.975),2), ")", sep=""), cex=1, font=2, col="darkgreen")

#Only observed locations
Pred_obs<-Pred_rf_obs$predictions
PropLocation<-100*cumsum(rep(1,M))/M
lines(Pred_obs[order(Pred_obs)], PropLocation, col="red")
text(-40,90, paste(round(median(Pred_obs),2), " (", round(quantile(Pred_obs,0.025),2), ", ", round(quantile(Pred_obs,0.975),2), ")", sep=""), cex=1, font=2, col="red")
```

#Shapley on min and max values with DALEX
```{r}
set.seed(1234)
summary(Training_1$Effect)
Training_1[which.max(Training_1$Effect),]
Training_1[which.min(Training_1$Effect),]

explain_rf <- DALEX::explain(model = mod.rf.1,  
                        data = Training_1,
                           y = Training_1$Effect, 
                       label = "Random Forest")
predict(explain_rf, Training_1[which.max(Training_1$Effect),])
predict(explain_rf, Training_1[which.min(Training_1$Effect),])

shap_min <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_1[which.min(Training_1$Effect),-1], 
                                 type = "shap",
                                    B = 25)
shap_max <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_1[which.max(Training_1$Effect),-1], 
                                 type = "shap",
                                    B = 25)
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_1[2,-1], 
                                 type = "shap",
                                    B = 25)

plot(shap_min)
plot(shap_max)
plot(shap_mean)

NewData$Effect <- predict(explain_rf, NewData)

##RCP 4.5, No Adaptation
if(drop_future){
  NewRCP <- NewData[which.min(NewData$Effect),-c(7,8)]
} else {
  NewRCP <- NewData[which.min(NewData$Effect),-c(8)]
}

shap_min <- predict_parts(explainer = explain_rf, 
                      new_observation = NewRCP, 
                                 type = "shap",
                                    B = 25)
shap_max <- predict_parts(explainer = explain_rf, 
                      new_observation = NewRCP, 
                                 type = "shap",
                                    B = 25)
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewRCP, 
                                 type = "shap",
                                    B = 25)

plot(shap_min)
plot(shap_max)
plot(shap_mean)
```

#Mean Shapley values for mapping
```{r}
set.seed(1234)

explain_rf <- DALEX::explain(model = mod.rf.1,  
                        data = Training_1,
                           y = Training_1$Effect, 
                       label = "Random Forest")

#0.11 minutes for 1 row
shap_co2ppm <- vector(length=dim(Training_1)[1])
start.time <- Sys.time()
for (i in 1:dim(Training_1)[1]){
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = Training_1[i,-1], 
                                 type = "shap",
                                    B = 25)
shap_co2ppm[i] <- shap_mean[shap_mean$variable_name=="CO2.ppm",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

NewData <- Training_1
NewData$shap_co2ppm <- shap_co2ppm

##Shap map plot
pdf(file=paste0(crop_species,"_shapmap.pdf"), height=8, width=8)
maps::map("world")
points(NewData$Longitude, NewData$Latitude, pch=19, col=NewData$CO2.ppm, cex=0.5)
text(0,100, paste0(crop_species," Shapley CO2ppm"))
dev.off()

#Then most important Shapley for each grid cell (must compute all)
```

#Mean Shapley value CO2ppm RCP4.5
```{r}
#RCP4.5
NewData<-data.frame(Delta_temp=rep(2, N),CO2.ppm=rep(116,N),Adaptation=as.factor(rep("No",N)),TempAvg=TAB_p_f$Tave, Latitude=TAB_p_f$y, Longitude=TAB_p_f$x, Future=rep(2060,N))
M<-nrow(DATA)
NewDataObs<-data.frame(Delta_temp=rep(2, M),CO2.ppm=rep(116,M),Adaptation=as.factor(rep("No",M)),TempAvg=DATA$TempAvg, Latitude=DATA$Latitude, Longitude=DATA$Longitude, Future=rep(2060,M))
levels(NewData$Adaptation)=c("No","Yes")
levels(NewDataObs$Adaptation)=c("No","Yes")

#Prediction RF
Pred_rf<-predict(mod.rf.1,data=NewData)
Pred_rf_obs<-predict(mod.rf.1,data=NewDataObs)

#Whole map
Pred=Pred_rf$predictions
NewData$Effect <- Pred

#Do the Shap part
set.seed(1234)

if(drop_future){
  NewData <- NewData[,-c(7)]
}

explain_rf <- DALEX::explain(model = mod.rf.1,  
                        data = Training_1,
                           y = Training_1$Effect, 
                       label = "Random Forest")

#3.5 hours
shap_co2ppm <- vector(length=dim(NewData)[1])
start.time <- Sys.time()
for (i in 1:dim(NewData)[1]){
shap_mean <- predict_parts(explainer = explain_rf, 
                      new_observation = NewData[i,-7], 
                                 type = "shap",
                                    B = 25)
shap_co2ppm[i] <- shap_mean[shap_mean$variable_name=="CO2.ppm",]$contribution[1]
}
end.time <- Sys.time()
end.time-start.time

save(shap_co2ppm, file="shap_co2ppm_4.5.RData")

LAT<-seq(83.75,-55.75, by= -0.5)
LONG<-seq(-179.75,179.75,by=0.5)

MAT <- raster(ncol=720, nrow=280, xmn=-179.75, xmx=179.75, ymn=-55.75, ymx=83.75)
Z <- matrix(NA, nrow=280, ncol=720)

List_of_latitude<-unique(NewData$Latitude)

for (i in List_of_latitude) {
	
LONG_i=(1:720)[LONG%in%NewData$Longitude[NewData$Latitude==i]]
LAT_i=(1:280)[LAT==i]

Z[LAT_i, LONG_i]<-shap_co2ppm[NewData$Latitude==i]

}

MAT<-setValues(MAT, Z)

pdf(file=paste0(crop_species,"_rcp4.5_shapmap.pdf"), height=8, width=8)
par(bty="n")
plot(MAT, col=rev(hcl.colors(25)), breaks=seq(-1,2.4,by=0.15))
text(0,100, paste0(crop_species," with RCP 4.5"))
maps::map("world", add=T)
dev.off()

```

